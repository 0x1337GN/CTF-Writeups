# PHP Stager

### Challenge Description
![image](https://github.com/LazyTitan33/CTF-Writeups/assets/80063008/74bea647-5946-4b11-b0bb-7b5c985875e8)

### Solution
Looking at the provided file, we can see it's a PHP script:  
![image](https://github.com/LazyTitan33/CTF-Writeups/assets/80063008/666bea6d-d233-4f0c-a69a-853d02eff48e)

I removed the large Base64 blob from it and gave it to ChatGPT to explain it to me and rename the variables. This is the output it gave me back:

```php
function decryptData($encryptedData, $encryptionKey = '') {
    $dataLength = strlen($encryptedData);
    $decryptedData = '';
    
    for ($dataIndex = 0; $dataIndex < $dataLength;) {
        for ($keyIndex = 0; $keyIndex < strlen($encryptionKey) && $dataIndex < $dataLength; $keyIndex++, $dataIndex++) {
            $decryptedData .= $encryptedData[$dataIndex] ^ $encryptionKey[$keyIndex];
        }
    }
    
    return $decryptedData;
}

$encryptedText = ")o4la2cih1kp97rmt*x5dw38b(sfy6;envguz_jq/.0";
$encryptionKey = "base64blob";
$partialText1 = "";
$partialText2 = "";

foreach([24, 4, 26, 31, 29, 2, 37, 20, 31, 6, 1, 20, 31] as $index){
    $partialText1 .= $encryptedText[$index];
}

foreach([26, 16, 14, 14, 31, 33] as $index){
    $partialText2 .= $encryptedText[$index];
}

$decryptionFunction = partialText2('n'.''.''.'o'.''.''.'i'.''.'t'.''.'c'.''.'n'.''.'u'.'f'.''.''.''.''.'_'.''.''.''.'e'.''.'t'.''.'a'.''.'e'.''.''.''.''.'r'.''.''.''.''.'c');
echo $decryptionFunction;
$decryptedContent = $decryptionFunction("/*XAjqgQvv4067*/", $partialText1(decryptData($partialText1($encryptionKey), "tVEwfwrN302")));
$decryptedContent();
```

It's somewhat more clear but we still need to investigate further. We don't know what the $partialText variables are so let's add some echo statements and run the php script:  
![image](https://github.com/LazyTitan33/CTF-Writeups/assets/80063008/9b25def2-1ee3-4d32-b2fb-f9423758d80f)

We get this output:  
![image](https://github.com/LazyTitan33/CTF-Writeups/assets/80063008/c79ed42e-6a3a-4b6d-b277-4ea0317c6534)

So in this case we know that partialText1 is `base64_decode` and partialText2 is `strrev`. This is becoming clearer now. The $decryptedFunction variable seems to only be an obfuscated way to create the `create_function` string which is a deprecated PHP function that we don't actually need in this scenario.
![image](https://github.com/LazyTitan33/CTF-Writeups/assets/80063008/c2693fad-a1a7-427e-910a-03d58e6ef502)

![image](https://github.com/LazyTitan33/CTF-Writeups/assets/80063008/b22c940e-9a0c-4bb1-a590-ab3f249d163b)

Let's go ahead and carve out the blob after we pass it to the decryptData function and base64 decode it:  
![image](https://github.com/LazyTitan33/CTF-Writeups/assets/80063008/b2f4585e-1555-464e-b8f0-4fc05de8d12c)

We get another stage of a PHP script with another Base64 blob:  
![image](https://github.com/LazyTitan33/CTF-Writeups/assets/80063008/02542942-ed85-495f-81a7-611ef1eddc36)

Decoding the first blob, we get a Perl script with an interesting string in it:  
![image](https://github.com/LazyTitan33/CTF-Writeups/assets/80063008/6fd281d6-4264-49ff-a2c4-0ded0a87c361)

My Perl skills are minimum at best so I asked ChatGPT to help me print out the decoded string and it gave me this script:

```perl
my $str = <<END;
begin 644 uuencode.uu
F9FQA9WLY8C5C-#,Q,V0Q,CDU.#,U-&)E-C(X-&9C9#8S9&0R-GT`
`
end
END

my ($encoded_data) = $str =~ m/begin 644 uuencode.uu\n(.*?)\nend/s;
my $decoded_data = unpack("u", $encoded_data);

print $decoded_data;
```

After running it, surprisingly enough, it works first try and we get the flag:  
![image](https://github.com/LazyTitan33/CTF-Writeups/assets/80063008/8bfa298e-22ce-4ef4-81c3-3779203d9f18)

flag{9b5c4313d12958354be6284fcd63dd26}
