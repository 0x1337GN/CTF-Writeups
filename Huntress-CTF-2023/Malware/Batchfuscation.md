# Batchfuscation

### Challenge Description
![image](https://github.com/LazyTitan33/CTF-Writeups/assets/80063008/afebedcd-57cb-4841-9258-94a218c3b233)

### Solution
As expected, the title of the challenge pretty much describes what we are dealing with. After we download the file, we can clearly see an obfuscated batch script:  
![image](https://github.com/LazyTitan33/CTF-Writeups/assets/80063008/f220c150-217e-440a-810c-00c7c3b8d51e)

We start by removing the first line and running the script in a segregated Windows VM and output everything to a text file:  
![image](https://github.com/LazyTitan33/CTF-Writeups/assets/80063008/d87398e8-8da8-4016-8e1d-fdcca3ef8ac0)

Now that it partially deobfuscated itself, we have a stage 2 file:  
![image](https://github.com/LazyTitan33/CTF-Writeups/assets/80063008/1d0d7fa9-bec3-4579-9032-6d34ae210337)

We see it setting several variables, some correspond with specific letters. Let's see which ones would correspond to f, l, a, g:  
We have our first letter of the flag:  
![image](https://github.com/LazyTitan33/CTF-Writeups/assets/80063008/2149bcb0-3a6e-4595-9f3d-1b4316cf2504)

Our second letter:  
![image](https://github.com/LazyTitan33/CTF-Writeups/assets/80063008/19129028-a759-47ba-9439-701d215f02da)

The "a" seems to be set in two different variables:  
![image](https://github.com/LazyTitan33/CTF-Writeups/assets/80063008/8f7d72ee-4a78-45f8-a05f-81c689f1182f)

We also find the "g" .. not the spot:  
![image](https://github.com/LazyTitan33/CTF-Writeups/assets/80063008/7462fd99-c8fe-43d6-9367-964460c4d476)

And the closing curly brace:  
![image](https://github.com/LazyTitan33/CTF-Writeups/assets/80063008/be5190f9-aa21-4ea7-9f74-dc3a6390ce6a)

After we do some replacemenet using CTRL+H (find and replace) to replace the variables with their corresponding letter, we can, after a while, find a `flag_character` being spelled out in several places:  
![image](https://github.com/LazyTitan33/CTF-Writeups/assets/80063008/c527037b-8c0a-4919-a70c-8cb24ce4dc0f)

We can make our lives easier with some bash scripting here to grep out only the lines where `flag_character` is found:  

![image](https://github.com/LazyTitan33/CTF-Writeups/assets/80063008/2ad2cf70-c342-4795-8fe0-6dc05cfface2)

We filter out to see only the letter and their corresponding equivalent and replace the remaining variables with their actual values we got from stage 2:  
![image](https://github.com/LazyTitan33/CTF-Writeups/assets/80063008/073b9940-56a8-4e78-9be0-9064dc1f5245)

There is some CTRL+F and CTRL+H action going on... as you can see, I did it all almost entirely manually. I'm definitely curious to see a writeup of a more automated approach:  
![image](https://github.com/LazyTitan33/CTF-Writeups/assets/80063008/79f3be1c-bd59-4a8c-915b-751e8a6a53e1)

Now we have all of the letters of the flag but their are not in order:  
![image](https://github.com/LazyTitan33/CTF-Writeups/assets/80063008/e73531f6-5b5f-4f05-ba85-00a003b3c698)

We can use bash again to sort them and cut out only the characters after the equals sign and print out the flag:  
```bash
cat deobfuscated|sort|awk -F "=" '{print $2}' ORS=
```
![image](https://github.com/LazyTitan33/CTF-Writeups/assets/80063008/57234a65-b7e0-40e8-a829-289a795f25aa)

flag{acad67e3d0b5bf31ac6639360db9d19a}
